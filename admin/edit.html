<link rel="stylesheet" href="__STATIC__/admin/src/editormd/css/editormd.css" />
<link rel="stylesheet" href="__STATIC__/layui_extends/mouseRightMenu/mouseRightMenu.css" />
<style>
	.markdown-body li{list-style: disc !important;}
</style>

<div class="layui-hide" id='enian-nav-bar'>
	<!-- 默认选中菜单左侧 -->
	<a type='menu' data-url="{:url('index/applist')}"></a>
	<a data-url="{:url('blog/bloglist')}">博客列表</a>
	<!--<a data-url="{:url('doc/docList')}">文档项目管理</a>-->
	<a data-url="">编辑博文</a>
</div>
<style type="text/css">
	body{
		background: #f2f2f2;
	}
	/*解决layui屏蔽li标签默认样式临时方案*/
	.markdown-body ul li{list-style: disc;}
	.markdown-body ul li li{list-style: circle;}
	.markdown-body ul li li li{list-style: square;}
	.markdown-body ol li{list-style: decimal;}
	.markdown-body ol li li{list-style: lower-roman;}
	.markdown-body ol li li li{list-style: lower-alpha;}
</style>

<div class="layui-card">
    <div class="layui-card-header">
	    {$doc_name} 
    	<button id='saveDoc' class="layui-btn layui-btn-sm" style="float: right;margin-top:7px ;margin-left:20px ;">保存文档</button>
    	<button id='checkImg' class="layui-btn layui-btn-sm" style="float: right;margin-top:7px ;">插入图片</button>
    	<button id='show' class="layui-btn layui-btn-sm" style="float: right;margin-top:7px ;">预览（HTML）</button>
    	
    </div>
    <div class="layui-card-body" >
    	<div id="editormd">
		  <textarea name="content"  style="display:none;">{$content}</textarea>                                     
		</div>
    </div>
   
</div>

<script src="__STATIC__/admin/src/editormd/jquery.min.js"></script>
<script src="__STATIC__/admin/src/editormd/editormd.min.js"></script>
<script type="text/javascript">
layui.use(['layer','jquery','fileManager','mouseRightMenu'],function(){
	var layer = layui.layer;
	var $ = layui.jquery;
	var fileManager = layui.fileManager;
	var editor = editor;
	var mouseRightMenu = layui.mouseRightMenu;
	//剪切板，type=0为剪切，type=1，为复制功能
	var clipboard={ids:0,type:0};

	var editor = editormd("editormd", {
			width: "100%",
            height:$(document).height() - 170 +'px',
            syncScrolling : true,
            codeFold:true,
            //imageUpload : true,
			imageFormats : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
			//imageUploadURL : "/index/test.html",
//			theme: "dark",//工具栏主题
//			editorTheme: "pastel-on-dark",//编辑主题
//			previewTheme: "dark",//预览主题
            path : "__STATIC__/admin/src/editormd/lib/" //修改文件目录引用的路径  mode, codemirror, marked... dependents libs path
       });
    //保存按钮点击
	$('#saveDoc').click(function(){
		saveDoc()
	});
	
	//保存按钮点击
	$('#show').click(function(){
		layer.open({
	      type: 2,
	      title: '预览，可以点击下方保存到HTML到数据库',
	      shadeClose: true,
	      shade: false,
	      maxmin: true, //开启最大化最小化按钮
	      area: ['893px', '600px'],
	      content: '/blog/preview.html?id={$_GET['id']}'
	    });
	});

	document.getElementById('editormd').onkeydown=function (e) { 
	  e=window.event||e;
	  //监听ctrl + s 保存
	  if(e.which== 83 && e.ctrlKey){
	 	   /*延迟，兼容FF浏览器  */
	 	  saveDoc()
//	 	    setTimeout(function(){
//	 		  alert('ctrl+s'); 
//	 	   },1); 
	         return false;      
	    }    
	}
	
	function saveDoc(){
		var data = editor.getMarkdown();
		$.ajax({
			type:"post",
			url: "{:url("",["t"=>2])}?id="+enianAdmin.url().params.id,
			data:{data:data},
			async:true,
			success:function(d){
				if(d.code==1){
					layer.msg('保存成功');
					//enianAdmin.go("{:url('doc/sonDocList')}?id="+enianAdmin.url().params.id)
				}else{
					layer.alert('保存失败')
				}
			},
			error:function(e){
				console.log(e)
				layer.alert('保存失败，错误信息，已打印到控制台！')
			}
		});
	}
	//插入图片按钮点击
	$('#checkImg').click(function(){
		layer.open({
		  type: 1,
		  //skin: 'layui-layer-rim', //加上边框
		  title:'选择图片，复制网址后，点击头部栏的添加图片，粘贴上即可',
		  area: ['800px', '500px'], //宽高
		  content: '<div id="checkImgWindow" class="fileManagerParent" style="height:400px;margin:10px"></div>',
		  success:function(){
		  	fileManager.render({
					elem:'#checkImgWindow',
					staticPath:'__STATIC__/layui_extends/fileManager',
					imgSrc:true,
					uploadConfig:{
						url:"{:url('doc/upload')}",//上传地址
						done:function(result){
							if(result.code==1){
								layer.msg('上传成功');
							}else{
								layer.alert('上传失败。'+result.msg);
							}
							//上传结果
							console.log(result);	
						}
					},
					pageConfig:true,
					pageJump:function(obj,callback){
						console.log('分页数据：',obj);
						var arg={
								'dirId':obj.id,
								'limit':obj.limit,
								'page':obj.page
							};
						ajax("{:url('doc/getpathdata')}",arg,function(r,d){
								if(r){
									console.log(d);
									if(d.code == 1){
										callback(d.fileList,d.count);
									}else{
										layer.alert('加载出现了问题');
									}
								}
							})
					},
					getPathList:function(obj,callback){
						console.log(obj)
						id=(obj.id==0)?'ROOT':obj.id
						var arg={
								'dirId':obj.id,
								'limit':obj.limit,
								'page':1
							};
						ajax("{:url('doc/getpathdata')}",arg,function(r,d){
								if(r){
									console.log(d);
									if(d.code == 1){
										callback(d.fileList,d.count);
									}else{
										layer.alert('加载出现了问题');
									}
								}
							})
					},
					newDirDone:function(dirObj,name){
						console.log('新建文件夹',dirObj,name);
						ajax("{:url('doc/newDir')}",{'dirId':dirObj.id,'newDirName':name},function(r,d){
								if(r){
									//console.log(d);
									if(d.code == 1){
										layer.alert('新建成功')
										fileManager.reload()
									}else{
										layer.alert('新建失败');
									}
									
								}
							})	
					}
				})
		  }
		});
	});
	
	//点击文件
	fileManager.listenClick(function(data){
		console.log(data)
		if(data.type!="/DIR"){
			layer.prompt({title: '复制后，点击添加图片粘贴', formType: 2,value:data.src}, function(text, index){
			    layer.close(index);
			    //layer.msg('演示完毕！您的口令：'+ pass +'<br>您最后写下了：'+text);
			});
		}
		 
	})
	fileManager.listenClickRight(function(data){
		console.log(data)
		
		var menu_data=[
			{'data':data,'type':1,'title':'删除文件'},
			{'data':data,'type':2,'title':'重命名'},
			{'data':data,'type':3,'title':'剪切'},
			{'data':data,'type':4,'title':'复制'},
			
		]
		if(clipboard.ids){
			menu_data.push({'data':data,'type':5,'title':'粘贴'});
		}
		
		mouseRightMenu.open(menu_data,false,function(d){
			var checks = fileManager.getMoreCheck();
			var ids = [];
			if(d.type==1){
				layer.confirm('删除后无法恢复，确定要进行删除吗？', function(index){
					if(checks.length!=0){
						for (var i = 0; i < checks.length; i++) {
							ids[i] = checks[i].id;
						}
					}else{
						ids[0]=d.data.id;
					}
					ajax("{:url('doc/delFile')}",{'ids':ids},function(r,d){
						console.log(r,d)
						if(r && d.code==1){
							layer.msg('删除完成');
							fileManager.reload()
						}else{
							layer.alert('删除失败')
						}
					})
			        layer.close(index);
			    });
			}else if(d.type==2){
				//重命名
				 layer.prompt({title: '新名字', formType: 2,value:d.data.name}, function(text, index){
				    layer.close(index);
				    ajax("{:url('doc/rename')}?id="+d.data.id+'&newName='+text,{},function(r,d){
						//console.log(r,d)
						if(r && d.code==1){
							layer.msg('操作成功');
							fileManager.reload()
						}else{
							layer.alert('操作失败')
						}
					})
				  });
			}else if(d.type==3 || d.type==4){
				//剪切和复制
				if(checks.length!=0){
					for (var i = 0; i < checks.length; i++) {
						ids[i] = checks[i].id;
					}
				}else{
					ids[0]=d.data.id;
				}
				clipboard['type']=(d.type==3)?0:1;
				clipboard['ids'] = ids;
				console.log('剪切板',clipboard);
				fileManager.closeMoreCheck();
			}else if(d.type==5){
				//粘贴
				//console.log(d.data.id);
				console.log('粘贴板',clipboard);
				var path = d.data.id;//待粘贴的路径id
				var a_data={'type':clipboard['type'],'ids':clipboard['ids'],pathid:path};
				console.log(a_data);
				ajax("{:url('doc/paste')}",a_data,function(r,d){
						console.log(r,d)
						if(r && d.code==1){
							layer.msg('操作完成');
							fileManager.reload()
							if(clipboard['type']==0){
								clipboard['ids']=0;
							}
						}else{
							layer.alert('操作失败')
						}
				})
			}
			//return false;//阻止默认事件（关闭菜单）
		})
		
		return false;
	})
	
	//ajax 请求
	function ajax(url,data,done){
		$.ajax({
			type:"get",
			url:url,
			data:data,
			success:function(r){
				done(true,r)
			},
			error:function(r){
				done(false,r)
			},
			async:true
		});
	}
//	placeholder:'本编辑器支持Markdown编辑，左边编写，右边预览',  //默认显示的文字，这里就不解释了
//   width: "90%",
//   height: 640,
//   syncScrolling: "single",  
//   path: "lib/js/editor.md-master/lib/",   //你的path路径（原资源文件中lib包在我们项目中所放的位置）
//   theme: "dark",//工具栏主题
//   previewTheme: "dark",//预览主题
//   editorTheme: "pastel-on-dark",//编辑主题
//   saveHTMLToTextarea: true,
//   emoji: false,
//   taskList: true, 
//   tocm: true,         // Using [TOCM]
//   tex: true,                   // 开启科学公式TeX语言支持，默认关闭
//   flowChart: true,             // 开启流程图支持，默认关闭
//   sequenceDiagram: true,       // 开启时序/序列图支持，默认关闭,
//   toolbarIcons : function() {  //自定义工具栏，后面有详细介绍
//       return editormd.toolbarModes['simple']; // full, simple, mini
//    },


//  codeFold : true,
//  saveHTMLToTextarea : true,
//  searchReplace : true,
//  htmlDecode : "style,script,iframe|on*",
//  emoji : true,
//  taskList : true,
//  tocm : true,         // Using [TOCM]
//  tex : true,                   // 开启科学公式TeX语言支持，默认关闭
//  flowChart : true,             // 开启流程图支持，默认关闭
//  sequenceDiagram : true,       // 开启时序/序列图支持，默认关闭,
//  imageUpload : true,
//  imageFormats : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
//  //imageUploadURL : "examples/php/upload.php",
//  onload : function() {
//      console.log('onload', this);
//  }

});
</script>