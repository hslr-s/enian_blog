<div class="layui-hide" id='enian-nav-bar'>
 	<a data-url="">博客列表</a>
</div>

<div class="layui-btn-group">
	<button id='add' class="layui-btn layui-btn-sm layui-btn-primary">
  		<i class="layui-icon">&#xe61f;</i>添加
  	</button>
  	<button id='search' class="layui-btn layui-btn-sm layui-btn-primary">
  		<i class="layui-icon">&#xe615;</i>搜索
  	</button>
</div>

<div id="data"></div>

<div id="form"></div>



<script type="text/html" id="list_s_tool">
  <a class="layui-btn layui-btn-xs layui-btn-primary" lay-event="edit">修改</a>
  <a class="layui-btn layui-btn-xs layui-btn-primary" lay-event="edit_blog">编辑博客</a>
  <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="del">删除</a>
</script>

<script type="text/html" id="tag_s_tool">
  <a class="layui-btn layui-btn-xs layui-btn-primary" lay-event="edit_blog_tag">标签</a>
</script>

<script type="text/html" id="tag_form_tpl">
	<form class="layui-form" action="" style="margin: 20px">
  		<div class="layui-form-item" id="tag_list">
  		  	
  		</div>
  		<div class="layui-form-item">
		    <div class="layui-input-block">
		      <button type="submit" class="layui-btn" lay-submit="" lay-filter="save_tags">保存</button>
		      <button type="reset" class="layui-btn layui-btn-primary">重置</button>
		    </div>
		</div>
  	<form>
</script> 
      
<script>
layui.config({base: '/static/layui_extends/'})
layui.use(['table','form','laypage','jquery','element','enianTable'], function() {
	var table = layui.table,
	laypage = layui.laypage
	,$ = layui.jquery
	,enianTable = layui.enianTable
	,form = layui.form;
	var tableArg={where:[],order:[]};
	var formLayerIndex;//form表单弹窗序号
	
    
    var fieldData = [
    {tableHead:{"field":"id","width":80,"title":"ID","sort":true},"type":"noInput"}
//  ,{tableHead:{"field":"order","width":100,"title":"排序","edit":"text"},"type":"input"}
    ,{tableHead:{"field":"title","title":"标题"},"type":"input","typeData":{"msg":"请输入"}}
    ,{tableHead:{"field":"time","width":200,"title":"时间"},"type":"time"}
    ,{tableHead:{"field":"hasHtml","width":80,"title":"渲染"},"type":"noInput"}
//  ,{tableHead:{"field":"url","title":"地址"},"type":"input","typeData":{"msg":"请输入跳转链接"}}
    ,{tableHead:{"field":"gid","align":"center","width":150,"title":"分组"},"type":"select",typeData:{$groupList??'[]'}}
    ,{tableHead:{"field":"visit","align":"center",width:100,"title":"阅读"},"type":"noInput"}
    ,{tableHead:{"field":"status","align":"center","width":100,"title":"状态"},"type":"switch",typeData:{on:{data:1,name:'公开'},off:{data:0,name:'私密'}}}
    ,{tableHead:{"width":100,"align":"center","toolbar":"#tag_s_tool","title":"标签设置"},"type":false}

    ,{tableHead:{"width":200,"align":"center","fixed":"right","toolbar":"#list_s_tool"},"type":false}];
    
    layui.link('/static/layui_extends/enianTable/enianTable.css');
    var ets = enianTable.search(fieldData);
    $('#search').click(function(){
		ets.open();
    });
    
    //监听搜索
	ets.submit(function(d){
		console.log(d);
		getTable.renderObj().reload({
		  where:{where:d}
		  ,page: {
		    curr: 1 //重新从第 1 页开始
		  }
		});
	});
    
    $('#add').click(function(){
		enianTable.form({
            elem:"#form"
            ,data:fieldData
            ,submitBtn:'保存'
            ,layer:"添加新项目"
            ,submit:function(data){
            	console.log(data);
            	if(data.field.status){
            		data.field.status=1;
            	}else{
            		data.field.status=0;
            	}
            	$.ajax({
						type: 'POST',
						url: "{:url('',['t'=>4])}",
						data: data.field,
						success: function(data) {
							if(data.code == 1) {
								layer.msg('添加成功！');
								layer.close(formLayerIndex);
								enianAdmin.reload();
							} else {
								layer.alert('添加失败，请刷新后重试');
							}
						}
				});
			}
            ,layerSuccess:function(obj){
				formLayerIndex=obj.index;
			}
        })
        
    });
    
    var getTable = enianTable.table({
		elem:"#data"
		,url:"{:url('',['t'=>1])}"
		,data:fieldData
		,config:{
			limit:30
			,height:'full-120'
			,skin:'line'
			,page:true
			,autoSort: false
			,method:'post'
			//详见layui文档 数据表格 - 基本参数
		}
		,checkbox:function(field,obj){
			layer.tips(field.value + ' ' + field.name + '：'+ obj.elem.checked, obj.othis);
			if(obj.elem.checked){
		   		ajaxFiled('field='+ field.name +'&value=1&id=' + field.value)
		    }else{
		   		ajaxFiled('field='+ field.name +'&value=0&id=' + field.value)
		    }
		}
		,toolEvent:function(obj){
			var data = obj.data;
			console.log();

			//删除数据
			if(obj.event === 'del') {
				layer.confirm('确定此条删除吗？删除后不可恢复？', function(index) {
					layer.close(index);
					//删除
					var d_data = "id="+data.id;
					$.ajax({
							type: 'POST',
							url: "{:url("",["t"=>3])}",
							data: d_data,
							success: function(data) {
								//console.log(data);
								if(data.code == 1) {
									layer.msg('删除成功');
									obj.del();
								} else {
			
									layer.alert('删除失败，请刷新后重试');
								}
							}});
					});
			}else if(obj.event === 'edit') {
					console.log(data);
				    enianTable.form({
			            elem:"#form"
			            ,data:fieldData
			            ,submitBtn:'保存'
			            ,layer:"修改"
			            ,submit:function(data){
			            	console.log(data);
			            	if(data.field.status){
			            		data.field.status=1;
			            	}else{
			            		data.field.status=0;
			            	}
			            	$.ajax({
									type: 'POST',
									url: "{:url('',['t'=>5])}",
									data: data.field,
									success: function(data) {
										if(data.code == 1) {
											layer.msg('修改成功！');
											layer.close(formLayerIndex);
											enianAdmin.reload();
										} else {
											layer.alert('修改失败，请刷新后重试');
										}
									}
							});
						}
			            ,val:data
			            ,layerSuccess:function(obj){
							formLayerIndex=obj.index;
						}
			        })
			}else if(obj.event === 'edit_blog') {
				enianAdmin.go('/blog/edit.html?id='+data.id);
			}else if(obj.event === 'edit_blog_tag'){
				layer.open({
				  type: 1,
				  title:'选择标签',
				  area: ['420px', '240px'], //宽高
				  content: $('#tag_form_tpl').html(),
				  success:function(){
				  	$.ajax({
						type: 'POST',
						url: "{:url('',['t'=>6])}?a_id="+data.id,
						success: function(res) {
							var html='';
							for(var k in res.data){
								console.log(res.data[k]['checked'])
								if(res.data[k]['checked']==1){
									html+=`<input type="checkbox" name="t_ids[${res.data[k].id}]" lay-skin="primary" title="${res.data[k].name}" checked="">`;
								}else{
									html+=`<input type="checkbox" name="t_ids[${res.data[k].id}]" lay-skin="primary" title="${res.data[k].name}">`;
								}
								console.log(html)
								
							}
							var inputHtml="<input type='text' class='layui-hide' name='a_id' value='"+data.id+"'>"
							$('#tag_list').html(html+inputHtml);
							form.render()
						}
					});
				  }
				});
				
				
			}
	}})
// 	console.log(table)
	
	//监听编辑
	getTable.on('edit',function(obj){
		var value = obj.value //得到修改后的值
    	,data = obj.data //得到所在行所有键值
   	 	,field = obj.field; //得到字段
// 	 	console.log(table)
   	 	var update_data="id="+data.id+"&field="+field+"&value="+ value;
 		ajaxFiled(update_data)
	})
	
	//监听排序
	getTable.on('sort',function(obj){
		console.log(obj.field); //当前排序的字段名
		console.log(obj.type); //当前排序类型：desc（降序）、asc（升序）、null（空对象，默认排序）
		//console.log(this); //当前排序的 th 对象
		tableArg.order= obj.field + " " + obj.type;
		console.log(tableArg);
		table.reload(getTable.id, {
		    initSort: obj //记录初始排序，如果不设的话，将无法标记表头的排序状态。
		    ,where: tableArg
		});
	})

	//监听提交
  	form.on('submit(save_tags)', function(data){
  	  	// layer.alert(JSON.stringify(data.field), {
  	  	//   title: '最终的提交信息'
  	  	// })
  	  	$.ajax({
			type: 'POST',
			url: "{:url('',['t'=>7])}",
			data:data.field,
			success: function(res) {
				if(res['code']==1){
					layer.closeAll()
				}else{
					layer.alert('保存失败');
				}
			}
		});
  	  	return false;
  	});
	  
  
	function ajaxFiled(d_data){
		$.ajax({
			type: 'POST',
			url: "{:url("",["t"=>2])}",
			data: d_data,
			success: function(data) {
				if(data.code == 1) {
					layer.msg('修改成功');
					
				} else {
					var msg = data.msg?' 原因：'+data.msg:'请刷新后重试。';
					layer.alert('修改失败，'+msg);
				}
			}});
		
	}

});
</script>
